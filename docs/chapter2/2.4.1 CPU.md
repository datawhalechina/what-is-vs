## 2.4.1 CPU 向量检索优化策略

中央处理器（CPU）作为计算的核心驱动力，其性能的优化是提升整体系统效率的关键一环。本章节将聚焦于CPU优化策略，揭示如何通过两大核心手段——高效利用CPU向量指令集进行距离计算与发挥多线程并发处理的优势——来挖掘CPU的潜力，为向量检索任务注入更强动力。

### 计算机体系结构基础
遵循经典的计算机体系结构划分，计算机系统由以下五大基本部件构成：算术逻辑单元、指令控制中心、数据存储模块、外部信息接收装置和结果展示设备。如图 1 所示。

<center>
    <img style="border-radius: 0.3125em;
    box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" 
    src="./img/cpu- arch.png" width="800">
    <div style="color:orange; border-bottom: 1px solid #d9d9d9;
    display: inline-block;
    color: #999;
    padding: 2px;">图1 计算机基本架构</div>
</center>

这一结构框架的提出，得益于计算机科学领域的奠基人冯·诺伊曼,在其1945年的里程碑式文献《EDVAC研究报告初版》中，通过101页的详实论述，系统性地阐述了计算机的构造原理,从而奠定了当代计算机体系架构的基石。

计算机运作的核心机制可概括为以下步骤：

- 系统互联：计算机的五大组件——运算器、控制器、存储器、输入设备、输出设备——通过内部通信线路紧密相连，形成一个有机整体。
- 程序存储与执行：待执行的任务（程序）预先被加载至存储器(M)中，程序由一系列有序指令构成，每条指令指示一项具体的计算操作。
指令处理流程：计算机启动后，控制器(CC)扮演着指挥官的角色，逐步从存储器提取指令，解析其内容后，指导运算器(CA)进行相应的数值处理。
- 数据交互：在指令执行期间，若需外部数据，控制器会向输入设备(I)发送请求，由输入设备将所需数据导入计算机内部。
- 结果处理：一旦运算完成，控制器负责将运算器产生的结果回存至存储器，或通过输出设备(O)将结果输出至外部，供用户查看。
- 循环执行与终止：此“取令-执行-反馈”流程反复进行，直至程序指令序列执行完毕。这一过程循环往复，直至抵达程序的尾声，最终用户获得预期的计算成果。

在现代计算机设计中，**运算器**与**控制器**通常集成在一起，构成中央处理器(CPU)。CPU作为核心，不仅统筹协调各部件间的协作，还直接执行复杂的数值运算。

### CPU SIMD距离计算优化

运算器（Arithmetic Logic Unit, ALU）是CPU内部负责执行基本算术和逻辑运算的硬件模块。它接收来自控制器的指令和数据，执行加法、减法、乘法、除法、逻辑与、逻辑或、逻辑异或等操作，并将结果返回给CPU的其他部分。传统的ALU设计是面向单个数据元素的处理，即每次操作只针对一对操作数。

SIMD 运算器是对传统运算器架构的一种扩展。它允许ALU在一个时钟周期内对多个数据元素执行相同的运算指令。

例如，一个简单的加法操作，传统上对两个数执行一次加法，而在SIMD模式下，一个指令可以同时对四个、八个甚至更多对的数执行加法操作。

这通过硬件上的并行计算单元实现，每个单元独立处理向量中的一个元素，这样不仅提高了单个运算的效率，更重要的是增加了数据处理的并行度，从而显著增强了CPU在处理大量数据时的性能。

SIMD运算器的特点：
- 向量寄存器：SIMD架构引入了宽位的向量寄存器，这些寄存器能够存储多个数据元素（比如4个或8个32位浮点数）。与之对应，SIMD指令可以同时对这些寄存器内的所有数据元素执行运算。
- 并行执行单元：SIMD运算器通常包含多个并行的执行单元，每个单元负责处理向量寄存器中的一部分数据。例如，在执行加法操作时，一个四路SIMD运算器可以在一个时钟周期内完成四个独立的加法运算。
- 指令集扩展：为了支持SIMD操作，CPU提供了专门的SIMD指令集，如Intel的SSE、AVX系列，AMD的SSE、AVX及FMA等。这些指令集允许编译器或程序员直接使用SIMD指令进行编程，实现数据的并行处理。这些指令集随着时间的推移逐渐增加支持的数据宽度，从最早的64位MMX到AVX-512的512位宽度。

下面将对目前 x86 体系结构和 ARM 体系结构 SIMD 指令集做简单的介绍：

**Intel SSE（Streaming SIMD Extensions）**：这是Intel处理器上的一组SIMD指令集扩展，它提供了128位的向量寄存器，可以同时对4个单精度浮点数或8个字节整数进行操作。

**Intel AVX（Advanced Vector Extensions）**：AVX是SSE的后续版本，提供了256位的向量寄存器，能够同时对8个单精度浮点数或16个字节整数进行操作。AVX2和AVX-512进一步增加了寄存器的大小和操作的能力。

**ARM NEON**：NEON是ARM处理器上的向量化指令集，提供了128位的向量寄存器，可以同时对4个单精度浮点数或16个字节整数进行操作。


### CPU多线程并发处理


